# Phase 03-1: 기반 설정 (LangSmith + seed)

## 목표

LangSmith 트레이싱을 연동하여 모든 LLM 호출을 모니터링하고, seed 파라미터를 추가하여 응답 재현성을 제어할 수 있도록 한다.

---

## 1. LangSmith 트레이싱 연동

### 1.1 환경 변수 설정

**.env 파일 수정**

```bash
# 기존
GEMINI_API_KEY=your_gemini_api_key
TAVILY_API_KEY=your_tavily_api_key
TOKEN_LIMIT_K=256

# 추가
LANGSMITH_TRACING=true
LANGSMITH_API_KEY=your_langsmith_api_key
LANGSMITH_PROJECT=gemini-hybrid-chatbot
```

### 1.2 app.py 수정

**파일**: `app.py`

**수정 내용**: 앱 시작 시 LangSmith 환경 변수 로드

```python
# 추가할 코드 (app.py 상단)
import os
from dotenv import load_dotenv

load_dotenv()

# LangSmith 트레이싱 활성화 확인
if os.getenv("LANGSMITH_TRACING") == "true":
    print("LangSmith tracing enabled")
```

### 1.3 자동 트레이싱 확인

LangChain/LangGraph는 환경 변수만 설정하면 **자동으로 트레이싱**된다.

```python
# 별도 코드 수정 없이 환경 변수만으로 작동
# LANGSMITH_TRACING=true
# LANGSMITH_API_KEY=...
# LANGSMITH_PROJECT=...

# 기존 LLM 호출이 자동으로 LangSmith에 기록됨
response = llm.invoke(messages)  # 자동 트레이싱
```

---

## 2. seed 파라미터 추가

### 2.1 sidebar.py 수정

**파일**: `component/sidebar.py`

**위치**: Model Settings expander 내부 (temperature, top_p, max_output_tokens 다음)

**추가할 코드**:

```python
# max_output_tokens 슬라이더 다음에 추가
seed = st.number_input(
    "Seed (재현성)",
    min_value=-1,
    max_value=2147483647,
    value=-1,
    step=1,
    help="응답 재현성 제어. -1은 랜덤, 양수는 고정 시드",
)
```

**반환 딕셔너리 수정**:

```python
return {
    # 기존 항목들...
    "gemini_api_key": gemini_key,
    "tavily_api_key": tavily_key,
    "model": model,
    "embedding_model": embedding_model,
    "temperature": temperature,
    "top_p": top_p,
    "max_output_tokens": max_output_tokens,
    "seed": seed if seed >= 0 else None,  # 추가
    # ...
}
```

### 2.2 react_graph.py 수정

**파일**: `service/react_graph.py`

**수정 1**: `__init__` 메서드에 seed 파라미터 추가

```python
def __init__(
    self,
    api_key: str,
    model: str = "gemini-2.0-flash",
    temperature: float = 0.7,
    top_p: float = 0.9,           # 추가
    max_output_tokens: int = 8192, # 추가
    seed: int = None,              # 추가
    max_iterations: int = 5,
    search_service: Any = None,
    embedding_service: Any = None,
    embedding_repo: Any = None,
    db_path: str = None,
):
    self.api_key = api_key
    self.model_name = model
    self.temperature = temperature
    self.top_p = top_p             # 추가
    self.max_output_tokens = max_output_tokens  # 추가
    self.seed = seed               # 추가
    # ...

    # LLM 초기화 수정
    llm_config = {
        "model": model,
        "google_api_key": api_key,
        "temperature": temperature,
        "top_p": top_p,
        "max_output_tokens": max_output_tokens,
    }
    if seed is not None:
        llm_config["seed"] = seed

    self._llm = ChatGoogleGenerativeAI(**llm_config)
```

### 2.3 app.py에서 파라미터 전달

**파일**: `app.py`

**수정 내용**: ReactGraphBuilder 생성 시 추가 파라미터 전달

```python
# 기존
graph_builder = ReactGraphBuilder(
    api_key=settings["gemini_api_key"],
    model=settings["model"],
    temperature=settings["temperature"],
    max_iterations=settings["max_iterations"],
    # ...
)

# 수정
graph_builder = ReactGraphBuilder(
    api_key=settings["gemini_api_key"],
    model=settings["model"],
    temperature=settings["temperature"],
    top_p=settings["top_p"],
    max_output_tokens=settings["max_output_tokens"],
    seed=settings["seed"],
    max_iterations=settings["max_iterations"],
    # ...
)
```

---

## 3. 변경 파일 요약

| 파일 | 변경 유형 | 내용 |
|------|----------|------|
| `.env` | 수정 | LangSmith 환경 변수 3개 추가 |
| `.env.example` | 수정 | LangSmith 환경 변수 예시 추가 |
| `app.py` | 수정 | dotenv 로드, ReactGraphBuilder 파라미터 추가 |
| `component/sidebar.py` | 수정 | seed 입력 필드 추가, 반환 딕셔너리 수정 |
| `service/react_graph.py` | 수정 | `__init__`에 top_p, max_output_tokens, seed 추가 |

---

## 4. 테스트 계획

### 4.1 LangSmith 트레이싱 테스트

1. LangSmith 대시보드 접속 (https://smith.langchain.com)
2. 앱에서 채팅 메시지 전송
3. 대시보드에서 트레이스 확인:
   - 프롬프트 전문
   - 토큰 사용량
   - 응답 시간
   - 모델 정보

### 4.2 seed 파라미터 테스트

```python
# 동일한 seed로 동일한 응답 확인
seed = 42
response1 = graph.invoke("안녕하세요", seed=42)
response2 = graph.invoke("안녕하세요", seed=42)
assert response1["text"] == response2["text"]  # 동일해야 함

# seed=-1 (랜덤)은 매번 다른 응답
```

---

## 5. 참고: LangSmith 환경 변수 상세

| 변수명 | 필수 | 설명 |
|--------|------|------|
| `LANGSMITH_TRACING` | O | `true`로 설정 시 트레이싱 활성화 |
| `LANGSMITH_API_KEY` | O | LangSmith API 키 |
| `LANGSMITH_PROJECT` | X | 프로젝트명 (기본값: `default`) |
| `LANGSMITH_ENDPOINT` | X | API 엔드포인트 (기본값: `https://api.smith.langchain.com`) |
