# Phase 03-3-3: ë°œê²¬ëœ ë¬¸ì œì  ì •ë¦¬

## 1. ê°œìš”

Phase 03-3-2 Casual Mode êµ¬í˜„ í›„ ì‹¤ì œ ì±„íŒ… í…ŒìŠ¤íŠ¸ì—ì„œ ë°œê²¬ëœ ë¬¸ì œì ë“¤.

---

## 2. ë°œê²¬ëœ ë¬¸ì œì 

### 2.1 Tool ì‚¬ìš© ì •ë³´ ì¤‘ë³µ í‘œì‹œ

**í˜„ìƒ:**
```
ğŸ”§ íˆ´ ì‚¬ìš© ì •ë³´
ì„ íƒëœ íˆ´: web_search, web_search, web_search
```
- ë™ì¼ ë„êµ¬ê°€ ì—¬ëŸ¬ ë²ˆ í‘œì‹œë¨
- ì´ì „ í„´ì˜ ë„êµ¬ ì •ë³´ê°€ í˜„ì¬ í„´ì— ì”ì¡´í•˜ëŠ” ê²ƒì²˜ëŸ¼ ë³´ì„

**ì˜ˆìƒ ì›ì¸:**
- `tool_history` ì¶”ì¶œ ë¡œì§ ë¬¸ì œ
- ë˜ëŠ” UI ë Œë”ë§ ì‹œ ì¤‘ë³µ ì²˜ë¦¬

**í™•ì¸ í•„ìš”:**
- `react_graph.py`ì˜ `current_turn_messages` ì¶”ì¶œ ë¡œì§ ì¬ê²€í† 
- `chat_tab.py`ì˜ tool í‘œì‹œ ë¡œì§ í™•ì¸

---

### 2.2 ì‘ë‹µì— `extras`/`signature` ë…¸ì¶œ

**í˜„ìƒ:**
```python
[{'type': 'text', 'text': "ì‘ë‹µ ë‚´ìš©...", 'extras': {'signature': 'CoENAb4+9vtjQ1kuLU...'}}]
```
- LLM ì‘ë‹µì˜ raw êµ¬ì¡°ê°€ ê·¸ëŒ€ë¡œ ë…¸ì¶œë¨
- `extras`, `signature` í•„ë“œê°€ ì‚¬ìš©ìì—ê²Œ ë³´ì„

**ì˜ˆìƒ ì›ì¸:**
- `response.content`ê°€ ë¬¸ìì—´ì´ ì•„ë‹Œ ë¦¬ìŠ¤íŠ¸ë¡œ ë°˜í™˜ë˜ëŠ” ê²½ìš° ì²˜ë¦¬ ëˆ„ë½
- Gemini APIì˜ ì‘ë‹µ êµ¬ì¡° ë³€ê²½ ê°€ëŠ¥ì„±

**í™•ì¸ í•„ìš”:**
- `react_graph.py`ì˜ `final_text` ì¶”ì¶œ ë¡œì§
- `AIMessage.content` íƒ€ì… ì²˜ë¦¬

---

### 2.3 ìš”ì•½ë¬¸ í’ˆì§ˆ ë¬¸ì œ

**í˜„ìƒ:**
```
ğŸ“‹ Summary
Turn 1-5 (2, 3í„´ ì œì™¸)

ê¹€ìƒë¯¼ê·¸ëŠ”ê°íˆì „ì„¤ì´ë¼ ë˜í¼ ì•¨ë²” ë° í’€ë„¤ì„ ìš”ì²­.
```

**ë¬¸ì œì :**
1. **ë„ˆë¬´ ì§§ìŒ**: 5ê°œ í„´ ëŒ€í™”ë¥¼ í•œ ë¬¸ì¥ìœ¼ë¡œ ìš”ì•½
2. **ê¸€ì ê¹¨ì§/ì˜ë¦¼**: "ê¹€ìƒë¯¼ê·¸ëŠ”ê°íˆì „ì„¤ì´ë¼..." ì´ë¦„ì´ ë¶ˆì™„ì „
3. **ë§¥ë½ ì†ì‹¤**: ì–´ë–¤ ì•¨ë²”ì¸ì§€, í’€ë„¤ì„ì´ ë­”ì§€ ë“± í•µì‹¬ ì •ë³´ ëˆ„ë½

**ì˜ˆìƒ ì›ì¸:**
- `compression_rate` ì„¤ì •ì´ ë„ˆë¬´ ê³µê²©ì 
- ìš”ì•½ í”„ë¡¬í”„íŠ¸ê°€ í•µì‹¬ ì •ë³´ ë³´ì¡´ì„ ê°•ì¡°í•˜ì§€ ì•ŠìŒ
- í•œê¸€ ì²˜ë¦¬ ë¬¸ì œ

**í™•ì¸ í•„ìš”:**
- `summary_generator.py` í”„ë¡¬í”„íŠ¸ ê²€í† 
- `compression_rate` ê¸°ë³¸ê°’ ë° ì ìš© ë¡œì§

---

### 2.4 í„´ ì œì™¸ í‘œì‹œ ì˜¤ë¥˜

**í˜„ìƒ:**
```
Turn 1-5 (2, 3í„´ ì œì™¸)
```

**ì‹¤ì œ ëŒ€í™” ë¶„ì„:**
| Turn | ë‚´ìš© | ì˜ˆìƒ ëª¨ë“œ |
|------|------|----------|
| 1 | "ì•ˆë…•?" | casual |
| 2 | "ë°˜ê°€ì›Œ" | casual |
| 3 | "ë°ì´í„° ì»·ì˜¤í”„ê°€ ëª‡ì´ì•¼" | normal |
| 4 | "ê¹€ìƒë¯¼ê·¸ëŠ”ê°íˆì „ì„¤ì´ë¼... ìµœê·¼ ì•¨ë²”" | normal |
| 5 | "í’€ ë„¤ì„ ì°¾ì•„ì¤˜" | normal |

**ë¬¸ì œì :**
- Turn 1, 2ê°€ casualì¸ë° Turn 2, 3ì´ ì œì™¸ë˜ì—ˆë‹¤ê³  í‘œì‹œ
- `excluded_turns` ê³„ì‚° ë¡œì§ ì˜¤ë¥˜ ê°€ëŠ¥ì„±

**í™•ì¸ í•„ìš”:**
- `_summary_node()`ì˜ `excluded_turns` ê³„ì‚°
- `normal_turn_ids` ì¶”ì ì´ ì •í™•í•œì§€

---

### 2.5 ë„êµ¬ ê²°ê³¼ ì¤‘ë³µ í‘œì‹œ

**í˜„ìƒ:**
```
ğŸ“Œ [web_search]
[ì›¹ ê²€ìƒ‰ ê²°ê³¼]
1. ì •ì¹˜ - ë‹¤ìŒë‰´ìŠ¤...

ğŸ“Œ [get_current_time]
2026-02-05 17:15:47 (KST)
```
- ì´ì „ í„´ì˜ ë„êµ¬ ê²°ê³¼ê°€ í˜„ì¬ í„´ì—ë„ í‘œì‹œë¨
- Turn 12, 13ì—ì„œ Turn 11ì˜ ë„êµ¬ ê²°ê³¼ê°€ ë°˜ë³µë¨

**ì˜ˆìƒ ì›ì¸:**
- `tool_results` ì¶”ì¶œì´ í˜„ì¬ í„´ë§Œ ëŒ€ìƒìœ¼ë¡œ í•˜ì§€ ì•ŠìŒ
- ë˜ëŠ” UIì—ì„œ ì´ì „ ë©”ì‹œì§€ì˜ tool_resultsë¥¼ ë‹¤ì‹œ í‘œì‹œ

**í™•ì¸ í•„ìš”:**
- `react_graph.py`ì˜ `tool_results` ì¶”ì¶œ ë¡œì§
- `chat_tab.py`ì˜ ë©”ì‹œì§€ë³„ tool_results í‘œì‹œ ë¡œì§

---

### 2.6 Casual ê°ì§€ ì¼ê´€ì„± ë¬¸ì œ

**í˜„ìƒ:**
- "ë°ì´í„° ì»·ì˜¤í”„ê°€ ëª‡ì´ì•¼" â†’ normalë¡œ ì²˜ë¦¬ë¨ (ë„êµ¬ ë¯¸ì‚¬ìš©)
- "ì˜¤ëŠ˜ ëª‡ì›” ë©°ì¹ ì´ì•¼" â†’ casualë¡œ ì²˜ë¦¬ë¨ (ë„êµ¬ ë¯¸ì‚¬ìš©)
- "íˆ´ì„ ì‚¬ìš©í•´" â†’ casualë¡œ ì²˜ë¦¬ë¨ (????)

**ë¬¸ì œì :**
- ìœ ì‚¬í•œ ì§ˆë¬¸ì¸ë° ë‹¤ë¥¸ ëª¨ë“œë¡œ ê°ì§€
- "íˆ´ì„ ì‚¬ìš©í•´"ëŠ” ëª…ì‹œì  ë„êµ¬ ìš”ì²­ì¸ë° casual ì²˜ë¦¬

**í™•ì¸ í•„ìš”:**
- `reasoning_detector.py`ì˜ casual ê°ì§€ ë¡œì§
- ì§§ì€ ë¬¸ì¥ ì²˜ë¦¬ ê·œì¹™

---

## 3. ìš°ì„ ìˆœìœ„

| ìˆœìœ„ | ë¬¸ì œ | ì˜í–¥ë„ | ë‚œì´ë„ |
|------|------|--------|--------|
| 1 | extras/signature ë…¸ì¶œ | ë†’ìŒ (UX ì¹˜ëª…ì ) | ë‚®ìŒ |
| 2 | ë„êµ¬ ì¤‘ë³µ í‘œì‹œ | ë†’ìŒ (í˜¼ë€) | ì¤‘ê°„ |
| 3 | ìš”ì•½ë¬¸ í’ˆì§ˆ | ì¤‘ê°„ (ë§¥ë½ ì†ì‹¤) | ì¤‘ê°„ |
| 4 | í„´ ì œì™¸ í‘œì‹œ ì˜¤ë¥˜ | ë‚®ìŒ (UIë§Œ) | ë‚®ìŒ |
| 5 | Casual ê°ì§€ ì¼ê´€ì„± | ì¤‘ê°„ | ë†’ìŒ |

---

## 4. ìˆ˜ì • ì™„ë£Œ ì‚¬í•­

### 4.1 extras/signature ë…¸ì¶œ ìˆ˜ì • âœ…

**íŒŒì¼**: `service/react_graph.py`

```python
def extract_text_from_content(content) -> str:
    """AIMessage.contentì—ì„œ í…ìŠ¤íŠ¸ë§Œ ì¶”ì¶œ

    - contentê°€ str: ê·¸ëŒ€ë¡œ ë°˜í™˜
    - contentê°€ list: text íƒ€ì…ë§Œ ì¶”ì¶œ, extras/signature ë¬´ì‹œ
    """
    if isinstance(content, list):
        text_parts = []
        for item in content:
            if isinstance(item, str):
                text_parts.append(item)
            elif isinstance(item, dict) and item.get("type") == "text":
                text_parts.append(item.get("text", ""))
        return "".join(text_parts)
    return str(content) if content else ""
```

- `_invoke_llm_with_token_tracking()` ìˆ˜ì •
- `invoke()` final_text ì¶”ì¶œ ìˆ˜ì •

### 4.2 Casual ê°ì§€ ì¼ê´€ì„± ìˆ˜ì • âœ…

**íŒŒì¼**: `service/reasoning_detector.py`

REQUEST_PATTERNS ê°•í™”:
```python
REQUEST_PATTERNS = [
    r"\?$",  # ë¬¼ìŒí‘œ
    r"í•´ì¤˜|ì•Œë ¤ì¤˜|ì°¾ì•„ì¤˜|ê²€ìƒ‰|ì„¤ëª…|ë­ì•¼|ì–´ë•Œ",
    r"í•´ë´|ì‚¬ìš©í•´|í•´ë¼|í•´\s*$",  # ëª…ë ¹í˜• ì¶”ê°€
    r"ëª‡\s*(ì‹œ|ì›”|ë…„|ì¼|ë¶„|ì´ˆ|ê°œ|ë²ˆ)",  # ì‹œê°„/ë‚ ì§œ ì¶”ê°€
    r"ì–¸ì œ|ì–´ë””|ëˆ„êµ¬|ë¬´ì—‡|ì–¼ë§ˆ",  # ì˜ë¬¸ì‚¬ ì¶”ê°€
    r"(ì´|ê°€)\s*ë­",
]
```

ìˆ˜ì • ê²°ê³¼:
- "íˆ´ì„ ì‚¬ìš©í•´" â†’ normal (ì´ì „: casual)
- "ì˜¤ëŠ˜ ëª‡ì›” ë©°ì¹ ì´ì•¼" â†’ normal (ì´ì „: casual)
- "ëª‡ ì‹œì•¼" â†’ normal (ì´ì „: casual)

### 4.3 ìš”ì•½ í’ˆì§ˆ ê°œì„  âœ…

**íŒŒì¼**: `prompt/summary/summary_generator.py`

í”„ë¡¬í”„íŠ¸ ê°œì„ :
- ê³ ìœ ëª…ì‚¬ ë³´ì¡´ ê·œì¹™ ì¶”ê°€ (ìƒëµ ê¸ˆì§€)
- ìµœì†Œ 100ì ê·œì¹™ ì¶”ê°€
- êµ¬ì²´ì  ì˜ˆì‹œ í¬í•¨ (ê¹€ìƒë¯¼, LangChain)

---

## 5. í…ŒìŠ¤íŠ¸

**íŒŒì¼**: `tests/test_phase_03_03.py`

16ê°œ í…ŒìŠ¤íŠ¸ ì¶”ê°€:
- `TestExtractTextFromContent` (6ê°œ)
- `TestCasualDetectionConsistency` (4ê°œ)
- `TestSummaryPromptImprovement` (3ê°œ)
- `TestInvokeLLMWithTokenTracking` (1ê°œ)
- `TestRequestPatterns` (2ê°œ)

---

### 4.4 Tool History ëˆ„ì  ë²„ê·¸ ìˆ˜ì • âœ…

**íŒŒì¼**: `service/react_graph.py`

**ì›ì¸**: SqliteSaver ì²´í¬í¬ì¸íŠ¸ê°€ ì´ì „ í„´ì˜ ToolMessageë¥¼ ì €ì¥í•˜ì—¬ `len(converted_messages)`ë¡œëŠ” í˜„ì¬ í„´ ì‹œì‘ì ì„ ì •í™•íˆ ì°¾ì„ ìˆ˜ ì—†ìŒ.

**ìˆ˜ì •**:
```python
# turn_idë¥¼ ì‚¬ìš©í•˜ì—¬ í˜„ì¬ í„´ì˜ ì‹œì‘ì ì„ ì •í™•íˆ ì°¾ìŒ
current_turn_start = None
for i, msg in enumerate(result_messages):
    if (isinstance(msg, HumanMessage) and
        getattr(msg, "additional_kwargs", {}).get("turn_id") == turn_count):
        current_turn_start = i
        break

if current_turn_start is not None:
    current_turn_messages = result_messages[current_turn_start:]
```

---

## 6. ë‚¨ì€ ë¬¸ì œ

### 6.1 ê¸°ì¡´ ì„¸ì…˜ ë°ì´í„°

ì´ë¯¸ ì €ì¥ëœ ì„¸ì…˜ì˜ tool_historyëŠ” ìˆ˜ì • ì „ ë°ì´í„°ì´ë¯€ë¡œ ì—¬ì „íˆ ëˆ„ì  í‘œì‹œë  ìˆ˜ ìˆìŒ.
**ìƒˆ ì„¸ì…˜ì—ì„œ í…ŒìŠ¤íŠ¸ ê¶Œì¥.**

### 6.2 í„´ ì œì™¸ í‘œì‹œ

casual ê°ì§€ ìˆ˜ì •ìœ¼ë¡œ ê°œì„ ë¨.

---

## 7. ê´€ë ¨ íŒŒì¼

- `service/react_graph.py` - extract_text_from_content, tool_history ì¶”ì¶œ
- `service/reasoning_detector.py` - REQUEST_PATTERNS
- `prompt/summary/summary_generator.py` - ìš”ì•½ í”„ë¡¬í”„íŠ¸
- `tests/test_phase_03_03.py` - í…ŒìŠ¤íŠ¸
