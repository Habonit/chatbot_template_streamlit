# Role: Senior AI Software Architect (Python & Gemini Expert)



# Project Context

ìœ ì§€ë³´ìˆ˜ê°€ ê°€ëŠ¥í•˜ê³  ê³„ì¸µí™”ëœ ì•„í‚¤í…ì²˜(Layered Architecture)ë¥¼ ê°€ì§„ 'Gemini í•˜ì´ë¸Œë¦¬ë“œ AI ì±—ë´‡' ì œì‘ í”„ë¡œì íŠ¸ì…ë‹ˆë‹¤. ëª¨ë“  ì½”ë“œëŠ” **Google AI Studio (Gemini API)** ê¸°ë°˜ì˜ ìµœì‹  `google-genai` SDKë¥¼ ì‚¬ìš©í•˜ë©° íŒ¨í‚¤ì§€ ê´€ë¦¬ëŠ” `uv`ë¥¼ ì‚¬ìš©í•©ë‹ˆë‹¤. (Vertex AI StudioëŠ” ì‚¬ìš©í•˜ì§€ ì•ŠìŒ)



# Goal

Streamlitì„ ê¸°ë°˜ìœ¼ë¡œ ì•„ë˜ì˜ ê³ ë„í™”ëœ ê¸°ëŠ¥ë“¤ì„ í¬í•¨í•˜ëŠ” ì—”í„°í”„ë¼ì´ì¦ˆê¸‰ í”„ë¡œì íŠ¸ êµ¬ì¡°ë¥¼ ìƒì„±í•˜ì‹­ì‹œì˜¤.



# Core Requirements



## 1. UI Structure (Tabs & Sidebar)

- **Tabs**:

    - [Chat íƒ­]: ë©”ì¸ ëŒ€í™”ì°½. ìµœê·¼ 3í„´ ì›ë¬¸ + ëˆ„ì  ìš”ì•½ë¬¸ ê¸°ë°˜ ì»¨í…ìŠ¤íŠ¸ ê´€ë¦¬.

    - [PDF ì „ì²˜ë¦¬ íƒ­]: `pdfplumber`ë¥¼ í™œìš©í•œ RAG íŒŒì´í”„ë¼ì¸ ì‹œê°í™”.

- **Sidebar**:

    - **API Key**: ì‚¬ìš©ìê°€ ì§ì ‘ ì…ë ¥í•˜ëŠ” í•„ë“œ (Gemini API Key, Tavily API Key).

    - **Model Selection**: ë‹¤ìŒ ì˜µì…˜ì„ ì œê³µí•˜ëŠ” ì…€ë ‰íŠ¸ë°•ìŠ¤ (Google AI Studio ê¸°ì¤€ 2026.01).

        - `gemini-2.5-flash`, `gemini-2.5-pro` (ê¶Œì¥)

        - `gemini-2.0-flash` (2026ë…„ 3ì›” ì¢…ë£Œ ì˜ˆì •, ë ˆê±°ì‹œ ì§€ì›ìš©)

    - **Embedding Model**: `gemini-embedding-001` (Google AI Studioì—ì„œ ìœ ì¼í•˜ê²Œ ì§€ì›ë˜ëŠ” ì„ë² ë”© ëª¨ë¸).

    - **Generation Config**: Temperature, Top-p ìŠ¬ë¼ì´ë”.

    - **External Search**: Tavily AI ê²€ìƒ‰ í™œì„±í™” í† ê¸€ ë° ê²€ìƒ‰ ê¹Šì´(basic/advanced) ì˜µì…˜.

    - **Session ID**: `{yyyymmddhhmm}` ê¸°ë°˜ ì„¸ì…˜ ê´€ë¦¬ ë° ì „í™˜.

    - **Token Usage**: ì¢Œì¸¡ í•˜ë‹¨ì— **í˜„ì¬ ì„¸ì…˜**ì˜ ëˆ„ì  í† í° ì‚¬ìš©ëŸ‰ ì‹¤ì‹œê°„ í‘œì‹œ.

### 1.1 PDF ì „ì²˜ë¦¬ íƒ­ UI ìƒì„¸

- **íŒŒì¼ ì—…ë¡œë“œ**: `st.file_uploader`ë¡œ ë‹¨ì¼ PDF ì—…ë¡œë“œ (20MB ì œí•œ).

- **ì§„í–‰ ìƒíƒœ í‘œì‹œ**:

    - `st.progress`ë¡œ ì „ì²´ ì§„í–‰ë¥  í‘œì‹œ.

    - ë‹¨ê³„ë³„ ìƒíƒœ ë©”ì‹œì§€: "í…ìŠ¤íŠ¸ ì¶”ì¶œ ì¤‘..." â†’ "ì²­í‚¹ ì¤‘..." â†’ "ì •ê·œí™” ì¤‘..." â†’ "ì„ë² ë”© ìƒì„± ì¤‘..." â†’ "ì™„ë£Œ".

- **ì‹œê°í™” í•­ëª©**:

    - ì´ ì²­í¬ ìˆ˜, í‰ê·  ì²­í¬ ê¸¸ì´ í†µê³„.

    - ì²­í¬ ëª©ë¡ í…Œì´ë¸” (ì¸ë±ìŠ¤, ì›ë³¸ í…ìŠ¤íŠ¸ ë¯¸ë¦¬ë³´ê¸°, ì •ê·œí™”ëœ í…ìŠ¤íŠ¸).

    - ì„ë² ë”© ì°¨ì› ì •ë³´ (3072ì°¨ì›, í•„ìš”ì‹œ 768ë¡œ ì¶•ì†Œ ì˜µì…˜).

- **ì•¡ì…˜ ë²„íŠ¼**: "ì „ì²˜ë¦¬ ì‹œì‘", "ì¸ë±ìŠ¤ ì‚­ì œ", "RAG Tool ë“±ë¡".



## 2. Advanced RAG & Tool Pipeline

- **Extraction**: `pdfplumber` ë¼ì´ë¸ŒëŸ¬ë¦¬ë¡œ 20MB ì´í•˜ ë‹¨ì¼ PDFì˜ í…ìŠ¤íŠ¸ë¥¼ ì¶”ì¶œí•©ë‹ˆë‹¤.

- **Processing**:

    1. **Recursive Chunking**: í…ìŠ¤íŠ¸ ë¶„í• .

    2. **LLM Normalization**: ê° ì²­í¬ë¥¼ LLMì„ í†µí•´ ê²€ìƒ‰ì— ìµœì í™”ëœ í˜•íƒœë¡œ ì •ê·œí™”.

    3. **Generate Description**: ì •ê·œí™”ê°€ ë˜ì—ˆë‹¤ë©´ í•´ë‹¹ ë¬¸ì„œë“¤ì„ ë°”íƒ•ìœ¼ë¡œ í•´ë‹¹ pdfì— ëŒ€í•œ description ì‘ì„±
        - ì¶”í›„ íˆ´ ì½œë§ì—ì„œ ì‚¬ìš©ìì˜ ì§ˆì˜ê°€ í•´ë‹¹ descriptionê³¼ ì—°ê´€ì´ ìˆë‹¤ë©´, íˆ´ì½œë§ì—ì„œ rag ì‹¤í–‰í•  ì˜ˆì •

    4. **Embedding & Storage**: ë²¡í„°í™” í›„ `pickle` íŒŒì¼ë¡œ ì €ì¥. ì •ê·œí™”ëœ í…ìŠ¤íŠ¸ì™€ ì„ë² ë”© ìˆ˜ì¹˜ë¥¼ Pandas DataFrameìœ¼ë¡œ ë Œë”ë§.

    5. **Vector Search**: `FAISS`ë¥¼ í™œìš©í•œ ìœ ì‚¬ë„ ê¸°ë°˜ ë²¡í„° ê²€ìƒ‰.

- **Tool Registration**: ì „ì²˜ë¦¬ ì™„ë£Œ ì‹œ í•´ë‹¹ ë°ì´í„°ë¥¼ ì¡°íšŒí•˜ëŠ” í•¨ìˆ˜ë¥¼ `tools`ë¡œ ë“±ë¡.

### 2.1 Recursive Chunking ì„¸ë¶€ì‚¬í•­

- **ì²­í¬ í¬ê¸°**: 1024ì ê¸°ì¤€ (ì•½ 250~500 í† í°).

- **ì˜¤ë²„ë© í¬ê¸°**: 256ì (ë¬¸ë§¥ ì—°ì†ì„± ìœ ì§€).

- **ë¶„í•  ì „ëµ** (ìš°ì„ ìˆœìœ„ ìˆœì„œ):

    1. ë¬¸ë‹¨ ë‹¨ìœ„ (`\n\n`)ë¡œ ë¶„í•  ì‹œë„.

    2. ë¬¸ë‹¨ì´ ì²­í¬ í¬ê¸° ì´ˆê³¼ ì‹œ ë¬¸ì¥ ë‹¨ìœ„ (`. `, `? `, `! `)ë¡œ ë¶„í• .

    3. ë¬¸ì¥ë„ ì´ˆê³¼ ì‹œ ë¬¸ì ë‹¨ìœ„ë¡œ ê°•ì œ ë¶„í• .

- **ë©”íƒ€ë°ì´í„° ë³´ì¡´**: ê° ì²­í¬ì— `chunk_index`, `start_char`, `end_char`, `source_page` ì €ì¥.

### 2.2 LLM Normalization ì„¸ë¶€ì‚¬í•­

- **ì‚¬ìš© ëª¨ë¸**: `gemini-2.5-flash` (ë¹„ìš© íš¨ìœ¨ì„±).

- **ëª©ì **: ì˜¤íƒˆì ìˆ˜ì •, ë¶ˆí•„ìš”í•œ ê¸°í˜¸/ê³µë°± ì œê±°, ê²€ìƒ‰ í‚¤ì›Œë“œ ê°•í™”, ì•½ì–´ í’€ì´.

- **ì •ê·œí™” í”„ë¡¬í”„íŠ¸ í…œí”Œë¦¿**:

```
ë‹¤ìŒ í…ìŠ¤íŠ¸ë¥¼ ê²€ìƒ‰ì— ìµœì í™”ëœ í˜•íƒœë¡œ ì •ê·œí™”í•˜ì„¸ìš”.
ê·œì¹™:
1. ì˜¤íƒˆìì™€ ë„ì–´ì“°ê¸° ì˜¤ë¥˜ë¥¼ ìˆ˜ì •í•©ë‹ˆë‹¤.
2. ë¶ˆí•„ìš”í•œ íŠ¹ìˆ˜ë¬¸ìì™€ ì¤‘ë³µ ê³µë°±ì„ ì œê±°í•©ë‹ˆë‹¤.
3. ì•½ì–´ê°€ ìˆë‹¤ë©´ ê´„í˜¸ ì•ˆì— í’€ì´ë¥¼ ì¶”ê°€í•©ë‹ˆë‹¤.
4. í•µì‹¬ í‚¤ì›Œë“œëŠ” ê·¸ëŒ€ë¡œ ìœ ì§€í•©ë‹ˆë‹¤.
5. ì›ë¬¸ì˜ ì˜ë¯¸ë¥¼ ë³€ê²½í•˜ì§€ ì•ŠìŠµë‹ˆë‹¤.

ì›ë³¸ í…ìŠ¤íŠ¸:
{chunk_text}

ì •ê·œí™”ëœ í…ìŠ¤íŠ¸:
```

- **ì˜ˆì‹œ**:

    - ì›ë³¸: `"AI ê¸°ìˆ ì€  ë¹ ë¥´ê²Œ ë°œì „ì¤‘ì´ë‹¤...LLMì´ ëŒ€ì„¸"`

    - ì •ê·œí™”: `"AI(ì¸ê³µì§€ëŠ¥) ê¸°ìˆ ì€ ë¹ ë¥´ê²Œ ë°œì „ ì¤‘ì´ë‹¤. LLM(ëŒ€ê·œëª¨ ì–¸ì–´ ëª¨ë¸)ì´ ëŒ€ì„¸"`

### 2.3 Tool Registration ì„¸ë¶€ì‚¬í•­

- **Tool í•¨ìˆ˜ ì‹œê·¸ë‹ˆì²˜**:

```python
def search_pdf_knowledge(query: str, top_k: int = 5) -> list[dict]:
    """
    PDFì—ì„œ ì¶”ì¶œí•œ ì§€ì‹ ë² ì´ìŠ¤ë¥¼ ê²€ìƒ‰í•©ë‹ˆë‹¤.

    Args:
        query: ê²€ìƒ‰í•  ì§ˆë¬¸ ë˜ëŠ” í‚¤ì›Œë“œ
        top_k: ë°˜í™˜í•  ìµœëŒ€ ê²°ê³¼ ìˆ˜ (ê¸°ë³¸ê°’: 5)

    Returns:
        ê´€ë ¨ ì²­í¬ ëª©ë¡ [{
            "content": str,  # ì •ê·œí™”ëœ í…ìŠ¤íŠ¸
            "score": float,  # ìœ ì‚¬ë„ ì ìˆ˜
            "metadata": dict  # chunk_index, source_page ë“±
        }]
    """
```

- **Gemini Function Calling ìŠ¤í‚¤ë§ˆ**:

```python
search_pdf_tool = {
    "name": "search_pdf_knowledge",
    "description": "ì—…ë¡œë“œëœ PDF ë¬¸ì„œì—ì„œ ê´€ë ¨ ì •ë³´ë¥¼ ê²€ìƒ‰í•©ë‹ˆë‹¤. ì‚¬ìš©ìê°€ PDF ë‚´ìš©ì— ëŒ€í•´ ì§ˆë¬¸í•  ë•Œ ì‚¬ìš©í•˜ì„¸ìš”.",
    "parameters": {
        "type": "object",
        "properties": {
            "query": {
                "type": "string",
                "description": "ê²€ìƒ‰í•  ì§ˆë¬¸ ë˜ëŠ” í‚¤ì›Œë“œ"
            },
            "top_k": {
                "type": "integer",
                "description": "ë°˜í™˜í•  ê²°ê³¼ ìˆ˜",
                "default": 5
            }
        },
        "required": ["query"]
    }
}
```

- **ë‹¤ì¤‘ PDF ì²˜ë¦¬**: ë‹¨ì¼ Toolë¡œ í†µí•© ê´€ë¦¬. ê° ì²­í¬ì˜ `metadata.source_file`ë¡œ ì¶œì²˜ êµ¬ë¶„.



## 3. Hybrid Inference Logic

- **Default Strategy**: ì¼ë°˜ ëŒ€í™”ëŠ” `gemini-2.5-flash` ëª¨ë¸ì„ ì‚¬ìš©í•˜ì—¬ ì‘ë‹µ ì†ë„ë¥¼ ìµœì í™”í•©ë‹ˆë‹¤.

- **Reasoning (CoT)**: ë³µì¡í•œ ì¶”ë¡ ì´ë‚˜ ë‚´ë¶€ ë°ì´í„° ì¡°íšŒê°€ í•„ìš”í•œ ê²½ìš° `gemini-2.5-pro` ëª¨ë¸ë¡œ ì „í™˜í•˜ì—¬ ì‚¬ê³  ê³¼ì •(Chain of Thought)ì„ ìˆ˜í–‰í•©ë‹ˆë‹¤.

    - **ìë™ ì „í™˜**: Tool Calling ê³¼ì •ì—ì„œ LLMì´ ìŠ¤ìŠ¤ë¡œ ë³µì¡í•œ ì¶”ë¡  í•„ìš” ì—¬ë¶€ë¥¼ íŒë‹¨í•˜ì—¬ ëª¨ë¸ì„ ì „í™˜í•©ë‹ˆë‹¤.

- **Visualization**: ëª¨ë“  íˆ´ í˜¸ì¶œê³¼ ì‚¬ê³  ê³¼ì •ì€ `st.expander` ë‚´ì— í‘œì‹œí•©ë‹ˆë‹¤.

- **Search**: Tavily AI ê²€ìƒ‰ê³¼ RAG íˆ´ì„ í•˜ì´ë¸Œë¦¬ë“œë¡œ ìš´ìš©í•©ë‹ˆë‹¤.

### 3.1 ëª¨ë¸ ìë™ ì „í™˜ ë¡œì§ ì„¸ë¶€ì‚¬í•­

- **ì „í™˜ ë©”ì»¤ë‹ˆì¦˜**: `switch_to_reasoning` Toolì„ ì‹œìŠ¤í…œì— ë“±ë¡.

- **ì‹œìŠ¤í…œ í”„ë¡¬í”„íŠ¸ì— í¬í•¨í•  ì§€ì‹œì‚¬í•­**:

```
ë‹¹ì‹ ì€ ë‘ ê°€ì§€ ëª¨ë“œë¡œ ë™ì‘í•©ë‹ˆë‹¤:
1. ì¼ë°˜ ëª¨ë“œ: ê°„ë‹¨í•œ ì§ˆë¬¸, ì¼ìƒ ëŒ€í™”, ì •ë³´ ì¡°íšŒ
2. ì¶”ë¡  ëª¨ë“œ: ë³µì¡í•œ ë¶„ì„, ë‹¤ë‹¨ê³„ ì¶”ë¡ , ë¹„êµ/í‰ê°€, ìˆ˜í•™ì  ê³„ì‚°

ë‹¤ìŒ ìƒí™©ì—ì„œëŠ” ë°˜ë“œì‹œ switch_to_reasoning íˆ´ì„ í˜¸ì¶œí•˜ì„¸ìš”:
- ì—¬ëŸ¬ ì •ë³´ë¥¼ ì¢…í•©í•˜ì—¬ ê²°ë¡ ì„ ë„ì¶œí•´ì•¼ í•  ë•Œ
- "ì™œ", "ì–´ë–»ê²Œ", "ë¹„êµí•´ì¤˜", "ë¶„ì„í•´ì¤˜" ë“±ì˜ ì‹¬ì¸µ ì§ˆë¬¸
- PDF ë‚´ìš©ì„ ê¸°ë°˜ìœ¼ë¡œ ì¶”ë¡ ì´ í•„ìš”í•  ë•Œ
- ìˆ˜í•™ì  ê³„ì‚°ì´ë‚˜ ë…¼ë¦¬ì  ë‹¨ê³„ê°€ í•„ìš”í•  ë•Œ
```

- **switch_to_reasoning Tool ìŠ¤í‚¤ë§ˆ**:

```python
switch_tool = {
    "name": "switch_to_reasoning",
    "description": "ë³µì¡í•œ ì¶”ë¡ ì´ í•„ìš”í•  ë•Œ í˜¸ì¶œí•©ë‹ˆë‹¤. ì´ íˆ´ì´ í˜¸ì¶œë˜ë©´ ë” ê°•ë ¥í•œ ì¶”ë¡  ëª¨ë¸ë¡œ ì „í™˜ë©ë‹ˆë‹¤.",
    "parameters": {
        "type": "object",
        "properties": {
            "reason": {
                "type": "string",
                "description": "ì¶”ë¡  ëª¨ë“œê°€ í•„ìš”í•œ ì´ìœ "
            }
        },
        "required": ["reason"]
    }
}
```

- **ì „í™˜ ì‹œì **: Tool í˜¸ì¶œ ì‘ë‹µ ìˆ˜ì‹  í›„, í•´ë‹¹ ìš”ì²­ì„ `gemini-2.5-pro`ë¡œ ì¬ì „ì†¡.

- **ë³µê·€ ì¡°ê±´**: í•´ë‹¹ ëŒ€í™” í„´ ì™„ë£Œ í›„ ë‹¤ìŒ ì‚¬ìš©ì ì…ë ¥ë¶€í„° `gemini-2.5-flash`ë¡œ ìë™ ë³µê·€.



## 4. Context Management

- **Context Structure**: ìµœê·¼ 3í„´ ì›ë¬¸ì€ ê·¸ëŒ€ë¡œ ìœ ì§€í•˜ë©°, ëˆ„ì  ìš”ì•½ë¬¸ê³¼ í•¨ê»˜ ì»¨í…ìŠ¤íŠ¸ë¥¼ êµ¬ì„±í•©ë‹ˆë‹¤.

- **Summary Logic**: `ì‹ ê·œ ìš”ì•½ë¬¸ = ì´ì „ ìš”ì•½ë¬¸ + ìµœê·¼ 3í„´ ì›ë¬¸` ê³µì‹ì„ ì‚¬ìš©í•˜ì—¬ í”„ë¡¬í”„íŠ¸ì˜ í† í° íš¨ìœ¨ì„ ê·¹ëŒ€í™”í•©ë‹ˆë‹¤.

### 4.1 Context Management ì„¸ë¶€ì‚¬í•­

- **í„´(Turn) ì •ì˜**: ì‚¬ìš©ì ë©”ì‹œì§€ 1ê°œ + AI ì‘ë‹µ 1ê°œ = 1í„´.

- **ì»¨í…ìŠ¤íŠ¸ êµ¬ì¡°**:

```
[System Prompt]
[ëˆ„ì  ìš”ì•½ë¬¸] (ìˆëŠ” ê²½ìš°)
---
[ìµœê·¼ 3í„´ ëŒ€í™” ì›ë¬¸]
- User: ...
- Assistant: ...
- User: ...
- Assistant: ...
- User: ...
- Assistant: ...
---
[í˜„ì¬ ì‚¬ìš©ì ì…ë ¥]
```

- **ìš”ì•½ë¬¸ ìƒì„± ì‹œì **: ëŒ€í™”ê°€ 3í„´ì„ ì´ˆê³¼í•  ë•Œë§ˆë‹¤ ê°€ì¥ ì˜¤ë˜ëœ 3í„´ì„ ìš”ì•½í•˜ì—¬ ëˆ„ì .
    - ì˜ˆ: 1í„´ ëŒ€í™”ì‹œ: 1í„´ ì›ë¬¸ ìœ ì§€
    - ì˜ˆ: 2í„´ ëŒ€í™”ì‹œ: 1~2í„´ ì›ë¬¸ ìœ ì§€
    - ì˜ˆ: 3í„´ ëŒ€í™”ì‹œ: 1~3í„´ ì›ë¬¸ ìœ ì§€
    - ì˜ˆ: 4í„´ ëŒ€í™”ì‹œ: 1~3í„´ì— ëŒ€í•œ ìš”ì•½, 4í„´ ì›ë¬¸ìœ ì§€
    - ì˜ˆ: 5í„´ ëŒ€í™”ì‹œ: 1~3í„´ì— ëŒ€í•œ ìš”ì•½, 4~5í„´ ì›ë¬¸ìœ ì§€
    - ì˜ˆ: 6í„´ ëŒ€í™”ì‹œ: 1~3í„´ì— ëŒ€í•œ ìš”ì•½, 4~6í„´ ì›ë¬¸ìœ ì§€
    - ì˜ˆ: 7í„´ ëŒ€í™”ì‹œ: 1~3í„´ì— ëŒ€í•œ ìš”ì•½, 4~6í„´ì— ëŒ€í•œ ìš”ì•½, 7í„´ ì›ë¬¸ ìœ ì§€ì§€


- **ìš”ì•½ í”„ë¡¬í”„íŠ¸ í…œí”Œë¦¿**:

```
ë‹¤ìŒ ëŒ€í™” ë‚´ìš©ì„ ê°„ê²°í•˜ê²Œ ìš”ì•½í•˜ì„¸ìš”.
í•µì‹¬ ì •ë³´, ì‚¬ìš©ìì˜ ìš”ì²­ ì‚¬í•­, ì¤‘ìš”í•œ ê²°ì • ì‚¬í•­ì„ í¬í•¨í•´ì•¼ í•©ë‹ˆë‹¤.
200ì ì´ë‚´ë¡œ ì‘ì„±í•˜ì„¸ìš”.

ì´ì „ ìš”ì•½ (ìˆëŠ” ê²½ìš°):
{previous_summary}

ì¶”ê°€í•  ëŒ€í™”:
{conversation_to_summarize}

í†µí•© ìš”ì•½:
```

- **í† í° ì œí•œ ì´ˆê³¼ ì²˜ë¦¬**:

    1. í˜„ì¬ ì»¨í…ìŠ¤íŠ¸ í† í° ìˆ˜ ê³„ì‚°.

    2. ëª¨ë¸ ì œí•œ(256k í† í°)ì˜ 80% ì´ˆê³¼ ì‹œ ê²½ê³  í‘œì‹œ.

    3. 100%ë¥¼ ë„˜ìœ¼ë©´ í˜„ì¬ ì„¸ì…˜ì—ì„œ ëŒ€í™” ë¶ˆê°€ëŠ¥í•˜ê²Œ ë§‰í˜€ì•¼ í•¨

    4.  ëª¨ë¸ ì œí•œ(256k í† í°)í† í°ì–‘ì€ í™˜ê²½ ë³€ìˆ˜ë¡œ ì¡°ì •í•  ìˆ˜ ìˆê²Œ í•´ì•¼ í•¨(128,256,512,768 ì¤‘ì— ê³ ë¥¼ ìˆ˜ ìˆê²Œ)



## 5. Session Management

### 5.1 ì„¸ì…˜ ë°ì´í„° êµ¬ì¡°

- **ì €ì¥ ìœ„ì¹˜**: `data/sessions/{session_id}/` ë””ë ‰í† ë¦¬.

- **ì„¸ì…˜ë³„ íŒŒì¼ êµ¬ì¡°**:

```
data/sessions/202601151430/
â”œâ”€â”€ conversation.csv      # ëŒ€í™” ê¸°ë¡
â”œâ”€â”€ embeddings.pkl        # FAISS ì¸ë±ìŠ¤ + ì²­í¬ ë°ì´í„°
â”œâ”€â”€ metadata.json         # ì„¸ì…˜ ë©”íƒ€ë°ì´í„°
â””â”€â”€ token_usage.json      # í† í° ì‚¬ìš©ëŸ‰ ê¸°ë¡
```

### 5.2 conversation.csv êµ¬ì¡°

| ì»¬ëŸ¼ëª… | íƒ€ì… | ì„¤ëª… |
|--------|------|------|
| turn_id | int | í„´ ë²ˆí˜¸ |
| role | str | "user" ë˜ëŠ” "assistant" |
| content | str | ë©”ì‹œì§€ ë‚´ìš© |
| timestamp | str | ISO 8601 í˜•ì‹ |
| input_tokens | int | ì…ë ¥ í† í° ìˆ˜ |
| output_tokens | int | ì¶œë ¥ í† í° ìˆ˜ |
| model_used | str | ì‚¬ìš©ëœ ëª¨ë¸ëª… |

- **ì¸ì½”ë”©**: UTF-8.

### 5.3 metadata.json êµ¬ì¡°

```json
{
    "session_id": "202601151430",
    "created_at": "2026-01-15T14:30:00",
    "last_updated": "2026-01-15T15:45:00",
    "pdf_files": ["document1.pdf"],
    "total_turns": 12,
    "current_summary": "ì‚¬ìš©ìëŠ” AI ì±—ë´‡ ê°œë°œì— ëŒ€í•´ ì§ˆë¬¸í–ˆìœ¼ë©°...",
    "settings": {
        "model": "gemini-2.5-flash",
        "temperature": 0.7,
        "top_p": 0.9
    }
}
```

### 5.4 ì„¸ì…˜ ì „í™˜ ë¡œì§

1. ì‚¬ì´ë“œë°”ì—ì„œ ì„¸ì…˜ ID ì„ íƒ ë˜ëŠ” ìƒˆ ì„¸ì…˜ ìƒì„±.

2. ê¸°ì¡´ ì„¸ì…˜ ì„ íƒ ì‹œ:

    - `conversation.csv`ì—ì„œ ëŒ€í™” ê¸°ë¡ ë¡œë“œ.

    - `embeddings.pkl`ì—ì„œ FAISS ì¸ë±ìŠ¤ ë¡œë“œ (ìˆëŠ” ê²½ìš°).

    - `metadata.json`ì—ì„œ ì„¤ì •ê°’ ë³µì›.

3. ìƒˆ ì„¸ì…˜ ìƒì„± ì‹œ:

    - í˜„ì¬ ì‹œê°„ ê¸°ë°˜ `{yyyymmddhhmm}` ID ìƒì„±.

    - ë¹ˆ ë””ë ‰í† ë¦¬ êµ¬ì¡° ì´ˆê¸°í™”.



## 6. Token Usage Tracking

### 6.1 í† í° ì •ë³´ ì¶”ì¶œ

- **Gemini API ì‘ë‹µ êµ¬ì¡°**:

```python
response = client.models.generate_content(...)
usage = response.usage_metadata
input_tokens = usage.prompt_token_count
output_tokens = usage.candidates_token_count
total_tokens = usage.total_token_count
```

### 6.2 í‘œì‹œ í˜•ì‹

- **ì‚¬ì´ë“œë°” í•˜ë‹¨ í‘œì‹œ**:

```
ğŸ“Š Token Usage (í˜„ì¬ ì„¸ì…˜)
â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
ì…ë ¥: 12,450 tokens
ì¶œë ¥: 8,320 tokens
ì´ê³„: 20,770 tokens
```

### 6.3 token_usage.json êµ¬ì¡°

```json
{
    "session_id": "202601151430",
    "cumulative": {
        "input_tokens": 12450,
        "output_tokens": 8320,
        "total_tokens": 20770
    },
    "by_model": {
        "gemini-2.5-flash": {"input": 10000, "output": 7000},
        "gemini-2.5-pro": {"input": 2450, "output": 1320}
    },
    "history": [
        {"turn": 1, "input": 150, "output": 200, "timestamp": "..."},
        ...
    ]
}
```



## 7. Tavily AI Integration

### 7.1 API í˜¸ì¶œ ë°©ë²•

- **ë¼ì´ë¸ŒëŸ¬ë¦¬**: `tavily-python` ì‚¬ìš©.
- search_depthì™€ max_results ì˜µì…˜ ëª¨ë‘ ì‚¬ì´ë“œë°”ì—ì„œ ì„ íƒ ê°€ëŠ¥ ê¸°ë³¸ê°’ì€ basic, 5ë¡œ ì§€ì •ì •

```python
from tavily import TavilyClient

tavily = TavilyClient(api_key=tavily_api_key)
results = tavily.search(
    query="ê²€ìƒ‰ì–´",
    search_depth="basic",  # ë˜ëŠ” "advanced"
    max_results=5
)
```

### 7.2 ê²€ìƒ‰ ê¹Šì´ ì˜µì…˜

| ì˜µì…˜ | ì„¤ëª… | ì‚¬ìš© ì¼€ì´ìŠ¤ |
|------|------|-------------|
| basic | ë¹ ë¥¸ ê²€ìƒ‰, ìƒìœ„ ê²°ê³¼ë§Œ | ê°„ë‹¨í•œ ì‚¬ì‹¤ í™•ì¸ |
| advanced | ì‹¬ì¸µ ê²€ìƒ‰, ë” ë§ì€ ì†ŒìŠ¤ ë¶„ì„ | ë³µì¡í•œ ì£¼ì œ, ë¹„êµ ë¶„ì„ |

### 7.3 ê²€ìƒ‰ ê²°ê³¼ ì»¨í…ìŠ¤íŠ¸ í†µí•©

- **Tool ìŠ¤í‚¤ë§ˆ**:

```python
tavily_search_tool = {
    "name": "web_search",
    "description": "ìµœì‹  ì •ë³´ë‚˜ ì‹¤ì‹œê°„ ë°ì´í„°ê°€ í•„ìš”í•  ë•Œ ì›¹ ê²€ìƒ‰ì„ ìˆ˜í–‰í•©ë‹ˆë‹¤.",
    "parameters": {
        "type": "object",
        "properties": {
            "query": {
                "type": "string",
                "description": "ê²€ìƒ‰í•  ì§ˆë¬¸"
            }
        },
        "required": ["query"]
    }
}
```

- **ê²°ê³¼ í¬ë§·íŒ…** (LLMì— ì „ë‹¬):

```
[ì›¹ ê²€ìƒ‰ ê²°ê³¼]
1. {title} - {url}
   {content snippet}

2. {title} - {url}
   {content snippet}
...
```

### 7.4 ê²€ìƒ‰ ì‹¤íŒ¨ ì²˜ë¦¬

- íƒ€ì„ì•„ì›ƒ (10ì´ˆ) ì´ˆê³¼ ì‹œ: "ì›¹ ê²€ìƒ‰ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤. ì €ì¥ëœ ì§€ì‹ìœ¼ë¡œ ë‹µë³€í•©ë‹ˆë‹¤." ë©”ì‹œì§€ í‘œì‹œ í›„ RAGë§Œìœ¼ë¡œ ì§„í–‰.

- API í‚¤ ì˜¤ë¥˜ ì‹œ: ì‚¬ì´ë“œë°”ì— ê²½ê³  í‘œì‹œ, ê²€ìƒ‰ ê¸°ëŠ¥ ë¹„í™œì„±í™”.



## 8. Error Handling

### 8.1 API í‚¤ ê²€ì¦

- **ê²€ì¦ ì‹œì **: ì•± ì‹œì‘ ì‹œ ë° í‚¤ ì…ë ¥/ë³€ê²½ ì‹œ.

- **Gemini í‚¤ ê²€ì¦**:

```python
def validate_gemini_key(api_key: str) -> bool:
    try:
        client = genai.Client(api_key=api_key)
        client.models.list()  # ê°„ë‹¨í•œ API í˜¸ì¶œ
        return True
    except Exception:
        return False
```

- **Tavily í‚¤ ê²€ì¦**: ê°„ë‹¨í•œ í…ŒìŠ¤íŠ¸ ê²€ìƒ‰ ìˆ˜í–‰.

- **UI í”¼ë“œë°±**: ìœ íš¨í•˜ë©´ ì´ˆë¡ìƒ‰ ì²´í¬ë§ˆí¬, ë¬´íš¨í•˜ë©´ ë¹¨ê°„ìƒ‰ X í‘œì‹œ.

### 8.2 PDF íŒŒì¼ ê²€ì¦

- **í¬ê¸° ì œí•œ**: 20MB ì´ˆê³¼ ì‹œ ì—…ë¡œë“œ ê±°ë¶€ + "20MB ì´í•˜ íŒŒì¼ë§Œ ì—…ë¡œë“œ ê°€ëŠ¥í•©ë‹ˆë‹¤" ë©”ì‹œì§€.

- **í˜•ì‹ ê²€ì¦**: `.pdf` í™•ì¥ì ë° MIME íƒ€ì… í™•ì¸.

- **ë‚´ìš© ê²€ì¦**: `pdfplumber`ë¡œ ì—´ ìˆ˜ ì—†ëŠ” ê²½ìš° "ì†ìƒëœ PDF íŒŒì¼ì…ë‹ˆë‹¤" ë©”ì‹œì§€.

- **ë¹ˆ íŒŒì¼ ì²˜ë¦¬**: í…ìŠ¤íŠ¸ ì¶”ì¶œ ê²°ê³¼ê°€ ë¹ˆ ê²½ìš° "í…ìŠ¤íŠ¸ë¥¼ ì¶”ì¶œí•  ìˆ˜ ì—†ëŠ” PDFì…ë‹ˆë‹¤ (ì´ë¯¸ì§€ ê¸°ë°˜ PDFì¼ ìˆ˜ ìˆìŒ)" ë©”ì‹œì§€.

### 8.3 API í˜¸ì¶œ ì¬ì‹œë„ ë¡œì§

```python
import time

def call_with_retry(func, max_retries=3, base_delay=1):
    for attempt in range(max_retries):
        try:
            return func()
        except RateLimitError:
            delay = base_delay * (2 ** attempt)  # Exponential backoff
            time.sleep(delay)
        except APIError as e:
            if attempt == max_retries - 1:
                raise
            time.sleep(base_delay)
    raise Exception("ìµœëŒ€ ì¬ì‹œë„ íšŸìˆ˜ ì´ˆê³¼")
```

### 8.4 FAISS ì¸ë±ìŠ¤ ì˜¤ë¥˜ ì²˜ë¦¬

- **ë¡œë“œ ì‹¤íŒ¨ ì‹œ**: "ì¸ë±ìŠ¤ íŒŒì¼ì´ ì†ìƒë˜ì—ˆìŠµë‹ˆë‹¤. PDFë¥¼ ë‹¤ì‹œ ì „ì²˜ë¦¬í•´ì£¼ì„¸ìš”." ë©”ì‹œì§€ + ìë™ ì‚­ì œ ì˜µì…˜.

- **ê²€ìƒ‰ ì‹¤íŒ¨ ì‹œ**: ë¹ˆ ê²°ê³¼ ë°˜í™˜ + ë¡œê·¸ ê¸°ë¡.



## 9. Data Storage Structure

### 9.1 ì „ì²´ ë””ë ‰í† ë¦¬ êµ¬ì¡°

```
data/
â”œâ”€â”€ sessions/
â”‚   â”œâ”€â”€ 202601151430/
â”‚   â”‚   â”œâ”€â”€ conversation.csv
â”‚   â”‚   â”œâ”€â”€ embeddings.pkl
â”‚   â”‚   â”œâ”€â”€ metadata.json
â”‚   â”‚   â””â”€â”€ token_usage.json
â”‚   â””â”€â”€ 202601161000/
â”‚       â””â”€â”€ ...
â””â”€â”€ uploads/
    â””â”€â”€ temp/  # ì„ì‹œ PDF íŒŒì¼ (ì²˜ë¦¬ í›„ ì‚­ì œ)
```

### 9.2 embeddings.pkl ë‚´ìš©

```python
{
    "faiss_index": faiss.IndexFlatIP,  # ì½”ì‚¬ì¸ ìœ ì‚¬ë„ìš© Inner Product
    "chunks": [
        {
            "chunk_index": 0,
            "original_text": "...",
            "normalized_text": "...",
            "embedding": np.array([...]),  # 768 ë˜ëŠ” 3072 ì°¨ì›
            "metadata": {
                "source_file": "document.pdf",
                "source_page": 1,
                "start_char": 0,
                "end_char": 1000
            }
        },
        ...
    ],
    "config": {
        "embedding_model": "gemini-embedding-001",
        "embedding_dim": 768,
        "created_at": "2026-01-15T14:35:00"
    }
}
```

### 9.3 ë°ì´í„° ì‚­ì œ/ì—…ë°ì´íŠ¸

- **ì„¸ì…˜ ì‚­ì œ**: í•´ë‹¹ ì„¸ì…˜ ë””ë ‰í† ë¦¬ ì „ì²´ ì‚­ì œ.

- **PDF ì¬ì „ì²˜ë¦¬**: ê¸°ì¡´ `embeddings.pkl` ì‚­ì œ í›„ ìƒˆë¡œ ìƒì„±.

- **ëŒ€í™” ê¸°ë¡ ì´ˆê¸°í™”**: `conversation.csv` ë‚´ìš© ë¹„ìš°ê¸° + `metadata.json`ì˜ `current_summary` ì´ˆê¸°í™”.



# Project Architecture (Mandatory)

```
project_root/
â”œâ”€â”€ app.py                    # ì—”íŠ¸ë¦¬ í¬ì¸íŠ¸
â”œâ”€â”€ pyproject.toml            # uv ê¸°ë°˜ ì„¤ì •
â”œâ”€â”€ .env.example              # í™˜ê²½ ë³€ìˆ˜ í…œí”Œë¦¿
â”œâ”€â”€ domain/
â”‚   â”œâ”€â”€ __init__.py
â”‚   â”œâ”€â”€ message.py            # Message ë°ì´í„° ëª¨ë¸
â”‚   â”œâ”€â”€ chunk.py              # Chunk ë°ì´í„° ëª¨ë¸
â”‚   â””â”€â”€ session.py            # Session ë°ì´í„° ëª¨ë¸
â”œâ”€â”€ repository/
â”‚   â”œâ”€â”€ __init__.py
â”‚   â”œâ”€â”€ conversation_repo.py  # CSV ê¸°ë°˜ ëŒ€í™” ì €ì¥/ë¡œë“œ
â”‚   â”œâ”€â”€ embedding_repo.py     # pickle/FAISS ì €ì¥/ë¡œë“œ
â”‚   â””â”€â”€ pdf_extractor.py      # pdfplumber í…ìŠ¤íŠ¸ ì¶”ì¶œ
â”œâ”€â”€ service/
â”‚   â”œâ”€â”€ __init__.py
â”‚   â”œâ”€â”€ llm_service.py        # Gemini API í˜¸ì¶œ, ëª¨ë¸ ì „í™˜
â”‚   â”œâ”€â”€ embedding_service.py  # ì„ë² ë”© ìƒì„±
â”‚   â”œâ”€â”€ rag_service.py        # ì²­í‚¹, ì •ê·œí™”, ê²€ìƒ‰
â”‚   â”œâ”€â”€ summary_service.py    # ì»¨í…ìŠ¤íŠ¸ ìš”ì•½
â”‚   â”œâ”€â”€ search_service.py     # Tavily ê²€ìƒ‰ í†µí•©
â”‚   â””â”€â”€ tool_manager.py       # Tool ë“±ë¡/ê´€ë¦¬
â”œâ”€â”€ component/
â”‚   â”œâ”€â”€ __init__.py
â”‚   â”œâ”€â”€ sidebar.py            # ì‚¬ì´ë“œë°” UI
â”‚   â”œâ”€â”€ chat_tab.py           # Chat íƒ­ UI
â”‚   â””â”€â”€ pdf_tab.py            # PDF ì „ì²˜ë¦¬ íƒ­ UI
â””â”€â”€ data/
    â”œâ”€â”€ sessions/             # ì„¸ì…˜ë³„ ë°ì´í„°
    â””â”€â”€ uploads/temp/         # ì„ì‹œ ì—…ë¡œë“œ
```



# Dependencies & Versions

### í•„ìˆ˜ ìš”êµ¬ì‚¬í•­

- **Python**: >= 3.11

- **OS**: Windows, macOS, Linux ëª¨ë‘ ì§€ì›

### ì£¼ìš” ë¼ì´ë¸ŒëŸ¬ë¦¬

```toml
[project]
name = "gemini-hybrid-chatbot"
version = "0.1.0"
requires-python = ">=3.11"

dependencies = [
    "streamlit",
    "google-genai",
    "pdfplumber",
    "faiss-cpu",
    "tavily-python",
    "pandas",
    "numpy",
    "python-dotenv",
]

[build-system]
requires = ["hatchling"]
build-backend = "hatchling.build"
```

### í”Œë«í¼ë³„ ì°¸ê³ ì‚¬í•­

- **Windows**: `faiss-cpu` ì„¤ì¹˜ ì‹œ Visual C++ ì¬ë°°í¬ íŒ¨í‚¤ì§€ í•„ìš”í•  ìˆ˜ ìˆìŒ.

- **macOS (Apple Silicon)**: `faiss-cpu`ëŠ” ARM ë„¤ì´í‹°ë¸Œ ì§€ì›.

- **Linux**: ì¶”ê°€ ì˜ì¡´ì„± ì—†ìŒ.



# Output

- ìœ„ ê³„ì¸µ êµ¬ì¡°ì— ë”°ë¥¸ ì „ì²´ ì†ŒìŠ¤ ì½”ë“œ.

- ë¶ˆí•„ìš”í•œ ì£¼ì„ì„ ë°°ì œí•˜ê³  ê¹”ë”í•˜ê³  ëª…í™•í•œ í”„ë¡œë•ì…˜ê¸‰ ì½”ë“œ ì‘ì„±.
