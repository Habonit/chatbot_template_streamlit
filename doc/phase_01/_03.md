# Phase 01 - 추가 개선 요구사항

이 문서는 Phase 01의 추가 개선 사항을 정의합니다.

> **참고**: 일부 항목은 `_02.md`의 미구현 항목(항목 1, 5)과 관련이 있습니다.

---

## 1. 기본 시스템 프롬프트 개선 (답변 품질 향상)

### 1.1 현재 상태
- 기본 시스템 프롬프트(`prompt/system/base.txt`)가 모드 전환에만 집중되어 있음
- **문제점**:
  - 툴 콜링 없는 일반 대화에서 답변이 너무 짧고 단답형으로 나옴
  - 충분한 설명, 예시, 맥락 제공 없이 핵심만 간략히 답변
  - 사용자가 추가 질문을 해야 상세 내용을 얻을 수 있음

### 1.2 개선 요구사항

#### 1.2.1 기본 시스템 프롬프트 수정
- **파일**: `prompt/system/base.txt`
- **목표**: 모든 대화에서 충실하고 상세한 답변 유도
- **수정된 프롬프트**:
```
당신은 친절하고 전문적인 AI 어시스턴트입니다.

## 답변 원칙
1. **충실한 답변**: 질문에 대해 충분한 설명과 맥락을 제공하세요.
2. **구체적 예시**: 가능한 경우 구체적인 예시나 사례를 포함하세요.
3. **구조화된 설명**: 복잡한 내용은 번호 매기기, 소제목 등을 사용해 구조화하세요.
4. **단답 금지**: "네", "아니오" 같은 단답 대신 이유와 배경을 함께 설명하세요.
5. **추가 정보 제공**: 관련된 유용한 정보가 있다면 함께 안내하세요.

## 동작 모드
당신은 두 가지 모드로 동작합니다:
1. **일반 모드**: 간단한 질문, 일상 대화, 정보 조회 - 하지만 여전히 충실하게 답변
2. **추론 모드**: 복잡한 분석, 다단계 추론, 비교/평가, 수학적 계산

다음 상황에서는 반드시 switch_to_reasoning 툴을 호출하세요:
- 여러 정보를 종합하여 결론을 도출해야 할 때
- "왜", "어떻게", "비교해줘", "분석해줘" 등의 심층 질문
- PDF 내용을 기반으로 추론이 필요할 때
- 수학적 계산이나 논리적 단계가 필요할 때
```

#### 1.2.2 구현
- 프롬프트 파일 직접 수정
- 코드 변경 불필요

---

## 2. Chain of Thought (CoT) 프롬프트 및 모델 전환 개선

### 2.1 현재 상태
- `switch_to_reasoning` 툴이 호출되면 모델을 `gemini-2.5-pro`로 전환하는 로직은 있음
- **문제점**:
  - Chain of Thought 전용 프롬프트가 없어 추론 과정이 명확하지 않음
  - 기존 시스템 프롬프트만 사용하여 추론 모드의 효과가 제한적
  - 답변이 끊기거나 불완전한 경우 발생
  - 사용자 질의와 함께 CoT 프롬프트가 명시적으로 적용되지 않음

### 2.2 개선 요구사항

#### 2.2.1 Chain of Thought 프롬프트 추가
- **파일 위치**: `prompt/system/chain_of_thought.txt` 생성
- **프롬프트 목적**: 복잡한 추론이 필요한 경우 단계별 사고 과정을 유도
- **프롬프트 내용**:
```
당신은 복잡한 문제를 단계별로 분석하는 전문 추론 AI입니다.

## 추론 프로세스
다음 단계를 따라 체계적으로 사고하고 답변하세요:

### 1단계: 문제 분석
- 질문의 핵심 요구사항을 파악합니다
- 필요한 정보와 제약 조건을 식별합니다
- 문제의 범위와 복잡도를 평가합니다

### 2단계: 정보 수집 및 정리
- 주어진 컨텍스트에서 관련 정보를 추출합니다
- PDF 문서나 검색 결과가 있다면 핵심 내용을 정리합니다
- 부족한 정보가 있다면 명시합니다

### 3단계: 논리적 추론
- 수집한 정보를 바탕으로 논리적 단계를 밟아갑니다
- 각 단계의 근거를 명확히 제시합니다
- 여러 가능성이 있다면 각각 검토합니다

### 4단계: 결론 도출 및 검증
- 추론 결과를 종합하여 결론을 도출합니다
- 결론의 타당성과 한계점을 검토합니다
- 필요시 대안이나 추가 고려사항을 제시합니다

## 답변 형식
- 각 단계를 소제목으로 구분하여 작성하세요
- 최종 결론은 명확하게 요약해서 제시하세요
- 불확실한 부분은 솔직하게 인정하세요

---

[사용자 질문]
{user_input}

[참고 컨텍스트]
{context}
```

#### 2.2.2 모델 전환 로직 개선
- **현재 로직** (`app.py`의 `handle_chat_message()`):
  - `switch_to_reasoning` 툴 호출 시 모델만 전환하고 기존 프롬프트 재사용
- **개선 방안**:
  1. `switch_to_reasoning` 툴 호출 감지
  2. Chain of Thought 프롬프트 로드 (`prompt/system/chain_of_thought.txt`)
  3. 사용자 질의와 CoT 프롬프트를 결합하여 새로운 프롬프트 구성
  4. `gemini-2.5-pro` 모델로 전환하여 생성
  5. 완전한 답변이 생성되도록 보장

#### 2.2.3 구현 위치
- **프롬프트 파일**: `prompt/system/chain_of_thought.txt` 생성
- **PromptLoader 확장**: `service/prompt_loader.py`에 `get_cot_prompt()` 메서드 추가
  ```python
  def get_cot_prompt(self, user_input: str, context: str = "") -> str:
      """Chain of Thought 프롬프트 가져오기"""
      template = self.load("system", "chain_of_thought.txt")
      return self.format(template, user_input=user_input, context=context)
  ```
- **로직 수정**: `app.py`의 `handle_chat_message()` 함수
  - `switch_to_reasoning` 툴 호출 시 CoT 프롬프트 적용
  - `PromptLoader.get_cot_prompt()`를 사용하여 프롬프트 로드
- **모델 고정**: `gemini-2.5-pro`로 고정 (현재 구현 유지)

#### 2.2.4 답변 완성도 보장
- 응답이 완전히 생성되도록 토큰 제한 확인
- 응답이 중간에 끊기지 않도록 재시도 로직 고려 (선택적)
- 응답 품질 검증 (선택적)

---

## 3. PDF 설명 생성 프롬프트 길이 조정

### 3.1 현재 상태
- `prompt/pdf/description.txt`에서 PDF 설명을 50자 이내로 생성하도록 지시
- **문제점**: 50자는 너무 짧아 PDF 문서의 핵심 내용을 충분히 설명하기 어려움

### 3.2 개선 요구사항

#### 3.2.1 프롬프트 수정
- **파일**: `prompt/pdf/description.txt`
- **변경 내용**: "50자 이내" → "256자 이내"
- **수정된 프롬프트**:
```
다음 문서 내용을 바탕으로 이 PDF 문서에 대한 설명(description)을 작성하세요.

## 작성 지침
1. 문서의 주제와 목적을 명확히 설명하세요
2. 문서에서 다루는 핵심 내용 2-3가지를 요약하세요
3. 256자 이내로 작성하세요

## 문서 내용 샘플
{sample_text}

## 설명
```

#### 3.2.2 구현
- 프롬프트 파일 직접 수정
- 코드 변경 불필요

---

## 4. CSV 다운로드 인코딩 개선

### 4.1 현재 상태
- CSV 다운로드 시 UTF-8 인코딩 사용
- **문제점**: Excel에서 CSV 파일을 열 때 한글이 깨지는 현상 발생

### 4.2 개선 요구사항

#### 4.2.1 인코딩 변경
- **현재**: UTF-8
- **변경**: UTF-8-SIG (BOM 포함 UTF-8)
- **효과**: Excel에서 한글 인코딩 문제 해결

#### 4.2.2 구현 위치
- **파일**: `component/sidebar.py`의 `_generate_csv_data()` 함수
- **현재 구현**: 함수가 `str`을 반환하고, `st.download_button`이 기본 인코딩 처리
- **수정 방법**:
  ```python
  # 현재 (StringIO 사용, str 반환)
  def _generate_csv_data(messages: list) -> str:
      output = io.StringIO()
      # ...
      return output.getvalue()

  # 변경 (BytesIO 사용, BOM 포함 bytes 반환)
  def _generate_csv_data(messages: list) -> bytes:
      output = io.BytesIO()
      output.write(b'\xef\xbb\xbf')  # UTF-8 BOM
      writer = csv.writer(io.TextIOWrapper(output, encoding='utf-8', newline=''))
      # ... (기존 로직)
      output.seek(0)
      return output.read()
  ```
- **대안**: 더 간단한 방법으로 str 반환 후 encode 처리
  ```python
  def _generate_csv_data(messages: list) -> bytes:
      # ... (기존 StringIO 로직)
      return output.getvalue().encode('utf-8-sig')
  ```

#### 4.2.3 추가 고려사항
- `ConversationRepository`의 CSV 저장 로직도 동일하게 UTF-8-SIG로 변경 고려 (선택적)
- 파일 저장과 다운로드의 인코딩 일관성 유지

---

## 5. 툴 콜링 정보 표시 개선

> **참고**: `_02.md` 항목 5와 동일한 요구사항입니다. 상세 구현 방안을 정의합니다.

### 5.1 현재 상태
- Chat 탭에서 메시지의 "Details" expander에 모델명과 토큰 정보만 표시
- **문제점**: 
  - 툴 콜링이 사용되었는지 확인하기 어려움
  - 어떤 툴이 사용되었는지, 어떤 인자로 호출되었는지 알 수 없음
  - 대화 내용만으로 추론해야 함

### 5.2 개선 요구사항

#### 5.2.1 Details Expander 확장
- **현재 표시**: Model, Tokens
- **추가 표시**: Tool Calls 정보
  - 툴 이름
  - 툴 호출 인자 (arguments)
  - 툴 실행 결과 요약 (선택적)

#### 5.2.2 데이터 저장
- **Message 도메인 모델 확장** (`domain/message.py`):
  - `function_calls` 필드 추가 (list[dict] 타입)
  - 각 dict는 `{"name": str, "args": dict}` 형태
  - `to_dict()`, `from_dict()` 메서드에 해당 필드 추가
  ```python
  @dataclass
  class Message:
      # ... 기존 필드
      function_calls: list[dict] = field(default_factory=list)
  ```
- **저장 시점**: `app.py`의 `handle_chat_message()`에서 `assistant_msg` 생성 시
  ```python
  assistant_msg = Message(
      # ... 기존 필드
      function_calls=result.get("function_calls", []),
  )
  ```

#### 5.2.3 UI 표시 형식
```
[Details] (expanded=False)

Model: gemini-2.5-pro
Tokens: 1,234 in / 567 out

Tool Calls (2):
━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━
1. switch_to_reasoning
   Arguments:
     - reason: "복잡한 분석이 필요함"

2. search_pdf_knowledge
   Arguments:
     - query: "AI 기술 동향"
     - top_k: 5
━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━
```

#### 5.2.4 구현 위치
- **도메인 모델**: `domain/message.py` - `function_calls` 필드 추가
- **컴포넌트**: `component/chat_tab.py` - Details expander에 Tool Calls 섹션 추가
- **로직**: `app.py` - `assistant_msg` 생성 시 `function_calls` 포함

---

## 6. Tavily 검색 프롬프트 추가

### 6.1 현재 상태
- Tavily 검색 결과를 `SearchService.format_for_llm()`으로 포맷팅하여 LLM에 전달
- **문제점**:
  - 검색 결과를 LLM이 어떻게 활용해야 하는지에 대한 프롬프트가 없음
  - `prompt/` 디렉토리에 Tavily 검색 관련 프롬프트 파일이 없음

### 6.2 개선 요구사항

#### 6.2.1 프롬프트 파일 생성
- **파일 위치**: `prompt/search/tavily_instruction.txt` 생성
- **프롬프트 목적**: 웹 검색 결과를 어떻게 활용할지 LLM에 지시

#### 6.2.2 프롬프트 내용
```
당신은 웹 검색 결과를 활용하여 사용자 질문에 답변하는 AI입니다.

## 검색 결과 활용 지침

### 정보 검증
1. 검색 결과의 출처와 신뢰도를 확인하세요
2. 최신 정보인지 날짜를 확인하세요
3. 여러 출처에서 일관된 정보를 우선시하세요

### 답변 작성
1. 검색 결과를 종합하여 구조화된 답변을 작성하세요
2. 검색 결과를 그대로 복사하지 말고, 자신의 언어로 재구성하세요
3. 중요한 정보는 출처를 함께 언급하세요
4. 검색 결과가 질문과 관련 없으면 일반 지식으로 답변하세요

### 답변 형식
- 핵심 내용을 먼저 요약하세요
- 세부 정보는 항목별로 정리하세요
- 관련 링크나 추가 참고자료가 있으면 안내하세요

---

## 웹 검색 결과
{search_results}

[사용자 질문]
{user_query}
```

#### 6.2.3 구현 위치
- **디렉토리 생성**: `prompt/search/` 디렉토리 생성 필요
- **프롬프트 파일**: `prompt/search/tavily_instruction.txt` 생성
- **PromptLoader 확장**: `service/prompt_loader.py`에 `get_tavily_prompt()` 메서드 추가
  ```python
  def get_tavily_prompt(self, search_results: str, user_query: str) -> str:
      """Tavily 검색 프롬프트 가져오기"""
      template = self.load("search", "tavily_instruction.txt")
      return self.format(template, search_results=search_results, user_query=user_query)
  ```
- **서비스 수정**: `app.py`의 `handle_chat_message()`
  - 검색 결과를 LLM에 전달할 때 `PromptLoader.get_tavily_prompt()` 사용

#### 6.2.4 통합 방법
- **현재**: 검색 결과를 `enhanced_prompt`에 `[Tool Result: web_search]` 형식으로 직접 추가
- **개선**: Tavily 프롬프트를 로드하여 검색 결과와 사용자 질의를 구조화하여 전달

---

## 7. PDF 정규화 진행 상태 표시 개선

> **참고**: `_02.md` 항목 1과 관련됩니다. 스피너 및 시간 표시 기능을 추가로 정의합니다.

### 7.1 현재 상태
- PDF 전처리 시 `st.progress()`로 진행률 표시
- 단계별 상태 메시지 표시
- **문제점**:
  - 스피너가 없어 진행 중임을 명확히 알기 어려움
  - 예상 시간과 남은 시간이 표시되지 않음
  - 시간 정보가 실시간으로 업데이트되지 않음

### 7.2 개선 요구사항

#### 7.2.1 스피너 추가
- **위치**: 진행 상태 영역
- **표시 방식**: `st.spinner()` 사용
- **표시 조건**: 각 단계 처리 중일 때 표시

#### 7.2.2 예상 시간 및 남은 시간 표시
- **표시 위치**: 진행 상태 메시지와 함께
- **표시 형식**:
  ```
  정규화 중... (예상 소요 시간: 약 2분 30초, 남은 시간: 약 1분 20초)
  ```
- **업데이트**: 실시간으로 업데이트 (각 청크 처리 후)

#### 7.2.3 시간 계산 로직
- **초기 추정**: 첫 번째 청크 처리 시간 측정
- **동적 업데이트**:
  - 처리된 청크 수와 경과 시간 기반
  - 공식: `남은 시간 = (경과 시간 / 처리된 청크 수) * 남은 청크 수`
- **표시 형식**:
  - 1분 미만: "약 XX초"
  - 1분 이상: "약 X분 XX초"

#### 7.2.4 UI 구성
```
[Progress Bar: 60%]
[Spinner] 정규화 중...
예상 소요 시간: 약 2분 30초
남은 시간: 약 1분 20초
처리된 청크: 120 / 200
```

#### 7.2.5 구현 위치
- **컴포넌트**: `component/pdf_tab.py`의 `_run_preprocessing()` 함수
- **수정 사항**:
  - `st.spinner()` 추가
  - 시간 계산 로직 추가
  - 상태 텍스트에 시간 정보 포함

---

## 구현 우선순위

> **`_02.md` 구현 완료 항목**: 세션별 히스토리 분리(4+7), API Key 피드백(2), Output Token 설정(6), CSV 다운로드(3), Overview 탭(8), 프롬프트 탭(9), 프롬프트 파일 관리(10)

1. **높음**:
   - 기본 시스템 프롬프트 개선 (항목 1) - 답변 품질 향상, 단답 방지
   - Chain of Thought 프롬프트 및 모델 전환 개선 (항목 2) - 핵심 기능
   - 툴 콜링 정보 표시 (항목 5) - 사용자 경험 개선
2. **중간**:
   - Tavily 검색 프롬프트 추가 (항목 6)
   - PDF 정규화 진행 상태 개선 (항목 7)
3. **낮음**:
   - PDF 설명 길이 조정 (항목 3) - 프롬프트 파일만 수정
   - CSV 인코딩 개선 (항목 4) - 간단한 수정

---

## 참고사항

- 모든 프롬프트는 `prompt/` 디렉토리에 파일로 관리
- 프롬프트 변경 시 `PromptLoader`를 통해 로드
- **현재 프롬프트 디렉토리 구조**:
  ```
  prompt/
  ├── system/
  │   ├── base.txt              # 기본 시스템 프롬프트
  │   ├── pdf_extension.txt     # PDF 업로드 시 추가 지시사항
  │   └── chain_of_thought.txt  # (신규) CoT 프롬프트
  ├── summary/
  │   └── summary.txt           # 요약 프롬프트
  ├── pdf/
  │   ├── normalization.txt     # PDF 정규화 프롬프트
  │   └── description.txt       # PDF 설명 생성 프롬프트
  └── search/                   # (신규 디렉토리)
      └── tavily_instruction.txt # Tavily 검색 지시 프롬프트
  ```
- **PromptLoader 현재 메서드**: `get_system_prompt()`, `get_summary_prompt()`, `get_normalization_prompt()`, `get_description_prompt()`
- **추가 필요 메서드**: `get_cot_prompt()`, `get_tavily_prompt()`
- UI 개선은 Streamlit 기본 컴포넌트 우선 사용
- 사용자 경험을 고려하여 피드백은 즉각적이고 명확해야 함

---

## 8. 프롬프트 탭 갱신

### 8.1 현재 상태
- `component/prompts_tab.py`의 `get_prompt_info()`에서 프롬프트 목록을 하드코딩
- **누락된 프롬프트**:
  - `system/chain_of_thought.txt` (항목 2에서 추가)
  - `search/tavily_instruction.txt` (항목 6에서 추가)

### 8.2 개선 요구사항

#### 8.2.1 누락된 프롬프트 추가
- **파일**: `component/prompts_tab.py`의 `get_prompt_info()` 함수

#### 8.2.2 추가할 프롬프트 정보

```python
"chain_of_thought": {
    "title": "Chain of Thought Prompt",
    "description": "복잡한 추론이 필요한 경우 단계별 사고 과정을 유도하는 프롬프트입니다.",
    "usage": "switch_to_reasoning 툴이 호출되어 gemini-2.5-pro로 전환될 때 사용됩니다.",
    "content": prompt_loader.load("system", "chain_of_thought.txt"),
},
"tavily_instruction": {
    "title": "Tavily Search Instruction",
    "description": "웹 검색 결과를 활용하여 답변을 작성하도록 지시하는 프롬프트입니다.",
    "usage": "web_search 툴이 호출되어 Tavily 검색 결과를 LLM에 전달할 때 사용됩니다.",
    "content": prompt_loader.load("search", "tavily_instruction.txt"),
},
```

#### 8.2.3 프롬프트 표시 순서 (권장)
1. System Prompt (기본)
2. PDF Extension Prompt
3. Chain of Thought Prompt (신규)
4. Tavily Search Instruction (신규)
5. Summary Prompt
6. PDF Normalization Prompt
7. PDF Description Prompt

### 8.3 구현 우선순위
- **낮음**: 기능에는 영향 없음, UI 정보 표시 개선