# Phase 02-6: 저장소 통합 및 레거시 제거

## 1. 현재 상태 분석: 실패한 통합

### 1.1 Phase 02-5의 목표 vs 현실

Phase 02-5 문서에서는 "단일 저장소로 통합"을 목표로 했으나, **실제로는 3중 저장 구조**가 유지되고 있다.

```
┌─────────────────────────────────────────────────────────────────────────────┐
│                    현재: 3중 저장 (Phase 02-5 실패)                          │
└─────────────────────────────────────────────────────────────────────────────┘

                    ┌──────────────────┐
                    │   사용자 메시지   │
                    └────────┬─────────┘
                             │
         ┌───────────────────┼───────────────────┐
         │                   │                   │
         ▼                   ▼                   ▼
┌─────────────────┐ ┌─────────────────┐ ┌─────────────────┐
│   SqliteSaver   │ │ ConversationRepo│ │  SessionRepo    │
│  (langgraph.db) │ │ (CSV 파일)      │ │ (JSON 파일)     │
├─────────────────┤ ├─────────────────┤ ├─────────────────┤
│ - 그래프 상태   │ │ - 대화 히스토리 │ │ - 세션 메타데이터│
│ - messages      │ │ - messages      │ │ - summary       │
│ - summary       │ │   (중복!)       │ │ - token_usage   │
│ - tool_results  │ │                 │ │   (중복!)       │
└─────────────────┘ └─────────────────┘ └─────────────────┘
```

### 1.2 문제점

| 문제 | 설명 | 영향 |
|------|------|------|
| **데이터 중복** | 같은 messages가 SQLite와 CSV에 이중 저장 | 디스크 낭비, 동기화 버그 가능성 |
| **일관성 위험** | 3개 저장소 중 하나만 업데이트되면 불일치 | 데이터 손실, 세션 복원 실패 |
| **복잡한 코드** | app.py에서 3개 Repository를 모두 관리 | 유지보수 어려움, 버그 발생 확률 증가 |
| **목표 미달성** | "단일 저장소" 목표와 정반대 상태 | 기술 부채 누적 |

### 1.3 코드 증거

**app.py 라인 86, 146:**
```python
conv_repo.append_message(session_id, user_msg)   # CSV에 저장
conv_repo.append_message(session_id, assistant_msg)  # CSV에 또 저장
```

**app.py 라인 256-257:**
```python
session_repo.save_session(session)  # JSON에 저장
conv_repo.save_messages(session_id, st.session_state.messages)  # CSV에 저장
```

**service/react_graph.py:**
```python
self._checkpointer = SqliteSaver(self._conn)  # SQLite에 저장
```

→ **동일한 데이터가 3곳에 저장됨**

---

## 2. 목표: SQLite 단일 저장소

### 2.1 새로운 구조

```
┌─────────────────────────────────────────────────────────────────────────────┐
│                    목표: SQLite 단일 저장소                                  │
└─────────────────────────────────────────────────────────────────────────────┘

                    ┌──────────────────┐
                    │   사용자 메시지   │
                    └────────┬─────────┘
                             │
                             ▼
                ┌─────────────────────────┐
                │       SqliteSaver       │
                │     (langgraph.db)      │
                ├─────────────────────────┤
                │ - messages              │
                │ - summary               │
                │ - summary_history       │
                │ - tool_results          │
                │ - token_usage           │
                │ - pdf_description       │
                └─────────────────────────┘

삭제되는 것:
❌ ConversationRepository (CSV)
❌ SessionRepository (JSON)
❌ data/sessions/{session_id}/conversation.csv
❌ data/sessions/{session_id}/metadata.json

유지되는 것:
✅ EmbeddingRepository (PDF 임베딩 전용)
✅ data/sessions/{session_id}/embeddings.pkl
```

### 2.2 세션 관리 기능

SqliteSaver의 `thread_id`를 `session_id`로 사용하여 세션 관리:

| 기능 | 구현 방법 |
|------|----------|
| 세션 목록 조회 | SQLite에서 고유 thread_id 목록 쿼리 |
| 세션 전환 | thread_id 변경하여 invoke |
| 세션 복원 | SqliteSaver가 자동으로 상태 복원 |
| **히스토리 추출** | thread_id로 messages 조회 (새 기능) |

---

## 3. 세션 관리 서비스 설계

### 3.1 SessionManager 클래스

```python
# service/session_manager.py

import sqlite3
from pathlib import Path
from langchain_core.messages import BaseMessage, HumanMessage, AIMessage


class SessionManager:
    """SQLite 기반 세션 관리 서비스"""

    def __init__(self, db_path: str = "data/langgraph.db"):
        self.db_path = Path(db_path)
        self._conn = None

    def _get_connection(self) -> sqlite3.Connection:
        if self._conn is None:
            self._conn = sqlite3.connect(self.db_path, check_same_thread=False)
        return self._conn

    def list_sessions(self) -> list[str]:
        """저장된 모든 세션 ID 목록 반환"""
        conn = self._get_connection()
        cursor = conn.execute(
            "SELECT DISTINCT thread_id FROM checkpoints ORDER BY thread_id"
        )
        return [row[0] for row in cursor.fetchall()]

    def get_session_history(self, session_id: str) -> list[dict]:
        """
        세션의 대화 히스토리 추출

        Returns:
            [
                {"role": "user", "content": "안녕"},
                {"role": "assistant", "content": "안녕하세요!"},
                ...
            ]
        """
        conn = self._get_connection()
        cursor = conn.execute(
            """
            SELECT checkpoint
            FROM checkpoints
            WHERE thread_id = ?
            ORDER BY checkpoint_id DESC
            LIMIT 1
            """,
            (session_id,),
        )
        row = cursor.fetchone()
        if not row:
            return []

        # checkpoint에서 messages 추출
        import json
        checkpoint_data = json.loads(row[0])
        messages = checkpoint_data.get("channel_values", {}).get("messages", [])

        history = []
        for msg in messages:
            if isinstance(msg, dict):
                role = "user" if msg.get("type") == "human" else "assistant"
                content = msg.get("content", "")
            else:
                role = "user" if isinstance(msg, HumanMessage) else "assistant"
                content = msg.content
            history.append({"role": role, "content": content})

        return history

    def get_session_summary(self, session_id: str) -> str:
        """세션의 현재 요약 반환"""
        conn = self._get_connection()
        cursor = conn.execute(
            """
            SELECT checkpoint
            FROM checkpoints
            WHERE thread_id = ?
            ORDER BY checkpoint_id DESC
            LIMIT 1
            """,
            (session_id,),
        )
        row = cursor.fetchone()
        if not row:
            return ""

        import json
        checkpoint_data = json.loads(row[0])
        return checkpoint_data.get("channel_values", {}).get("summary", "")

    def delete_session(self, session_id: str) -> bool:
        """세션 삭제"""
        conn = self._get_connection()
        conn.execute("DELETE FROM checkpoints WHERE thread_id = ?", (session_id,))
        conn.execute("DELETE FROM writes WHERE thread_id = ?", (session_id,))
        conn.commit()
        return True

    def session_exists(self, session_id: str) -> bool:
        """세션 존재 여부 확인"""
        conn = self._get_connection()
        cursor = conn.execute(
            "SELECT 1 FROM checkpoints WHERE thread_id = ? LIMIT 1",
            (session_id,),
        )
        return cursor.fetchone() is not None

    def export_session_to_csv(self, session_id: str, output_path: str) -> None:
        """세션 히스토리를 CSV로 내보내기 (백업/분석용)"""
        import csv
        history = self.get_session_history(session_id)

        with open(output_path, "w", newline="", encoding="utf-8") as f:
            writer = csv.DictWriter(f, fieldnames=["turn", "role", "content"])
            writer.writeheader()
            for i, msg in enumerate(history, 1):
                writer.writerow({
                    "turn": (i + 1) // 2,
                    "role": msg["role"],
                    "content": msg["content"],
                })
```

### 3.2 사용 예시

```python
# 세션 목록 조회
manager = SessionManager()
sessions = manager.list_sessions()
# ["session_abc123", "session_def456", ...]

# 특정 세션 히스토리 추출
history = manager.get_session_history("session_abc123")
# [{"role": "user", "content": "파이썬이 뭐야?"}, {"role": "assistant", "content": "..."}]

# CSV로 내보내기 (백업용)
manager.export_session_to_csv("session_abc123", "backup.csv")
```

---

## 4. app.py 단순화

### 4.1 변경 전 (현재)

```python
# 현재: 3개 Repository 사용
def main():
    conv_repo = ConversationRepository(base_path=DATA_PATH)      # CSV
    embed_repo = EmbeddingRepository(base_path=DATA_PATH)        # Pickle (유지)
    session_repo = SessionRepository(base_path=DATA_PATH)        # JSON

    # 세션 변경 시
    save_current_session(session_repo, conv_repo)  # JSON + CSV 저장
    load_session_data(current_session, session_repo, conv_repo, embed_repo)

def handle_chat_message(...):
    conv_repo.append_message(session_id, user_msg)      # CSV에 저장
    # ... 그래프 실행 (SQLite에도 저장됨) ...
    conv_repo.append_message(session_id, assistant_msg)  # CSV에 또 저장

def save_current_session(session_repo, conv_repo):
    session_repo.save_session(session)                   # JSON 저장
    conv_repo.save_messages(session_id, messages)        # CSV 저장
```

### 4.2 변경 후

```python
# 변경 후: SessionManager + EmbeddingRepository만 사용
def main():
    session_manager = SessionManager()                   # SQLite
    embed_repo = EmbeddingRepository(base_path=DATA_PATH)  # Pickle (유지)

    # 세션 목록은 SQLite에서 조회
    saved_sessions = session_manager.list_sessions()

def handle_chat_message(...):
    # CSV 저장 코드 삭제
    # ReactGraphBuilder가 SqliteSaver로 자동 저장
    result = graph_builder.invoke(...)

# save_current_session() 삭제 - SqliteSaver가 자동 처리
# load_session_data() 단순화 - SqliteSaver가 자동 복원
```

---

## 5. 삭제 대상

### 5.1 파일 삭제

| 파일 | 이유 |
|------|------|
| `repository/conversation_repo.py` | SqliteSaver가 대체 |
| `repository/session_repo.py` | SqliteSaver + SessionManager가 대체 |
| `prompt/summary/summary.txt` | `summary_generator.py`와 중복 |

### 5.2 코드 삭제 (app.py)

| 위치 | 삭제 내용 |
|------|----------|
| import | `ConversationRepository`, `SessionRepository` |
| `handle_chat_message()` | `conv_repo.append_message()` 호출 (2곳) |
| `save_current_session()` | 함수 전체 삭제 또는 PDF 전용으로 축소 |
| `load_session_data()` | `conv_repo`, `session_repo` 의존성 제거 |
| `main()` | `conv_repo`, `session_repo` 초기화 제거 |

### 5.3 데이터 디렉토리 정리

```
data/sessions/{session_id}/
├── conversation.csv    ← 삭제 (SqliteSaver가 대체)
├── metadata.json       ← 삭제 (SqliteSaver가 대체)
└── embeddings.pkl      ← 유지 (PDF 임베딩)
```

---

## 6. 구현 계획

### Step 1: SessionManager 구현
- `service/session_manager.py` 생성
- `list_sessions()`, `get_session_history()`, `delete_session()` 구현
- `export_session_to_csv()` 구현 (히스토리 추출 기능)

### Step 2: app.py 수정
- `ConversationRepository`, `SessionRepository` import 제거
- `conv_repo.append_message()` 호출 제거
- `save_current_session()` 삭제
- `load_session_data()` → SessionManager 사용으로 변경
- 세션 목록 조회 → `SessionManager.list_sessions()` 사용

### Step 3: 레거시 파일 삭제
- `repository/conversation_repo.py` 삭제
- `repository/session_repo.py` 삭제
- `prompt/summary/summary.txt` 삭제
- `repository/__init__.py` 정리

### Step 4: 테스트 업데이트
- `tests/test_service.py`에 SessionManager 테스트 추가
- 레거시 Repository 테스트 제거

### Step 5: 통합 테스트
- 세션 전환 동작 확인
- 히스토리 추출 기능 확인
- 앱 재시작 후 세션 복원 확인

---

## 7. 구현 체크리스트

### Step 1: SessionManager 구현
- [x] `service/session_manager.py` 생성
- [x] `list_sessions()` 구현
- [x] `get_session_history()` 구현 (히스토리 추출)
- [x] `get_session_summary()` 구현
- [x] `delete_session()` 구현
- [x] `session_exists()` 구현
- [x] `export_session_to_csv()` 구현

### Step 2: app.py 수정
- [x] `ConversationRepository` import 제거
- [x] `SessionRepository` import 제거
- [x] `handle_chat_message()`에서 `conv_repo.append_message()` 제거
- [x] `save_current_session()` 삭제
- [x] `load_session_data()` 단순화
- [x] `main()`에서 `conv_repo`, `session_repo` 초기화 제거
- [x] 세션 목록 조회를 `SessionManager.list_sessions()` 사용으로 변경

### Step 3: 레거시 파일 삭제
- [x] `repository/conversation_repo.py` 삭제
- [x] `repository/session_repo.py` 삭제
- [x] `prompt/summary/summary.txt` 삭제
- [x] `repository/__init__.py`에서 삭제된 클래스 export 제거

### Step 4: 테스트
- [x] `tests/test_session_manager.py` 생성
- [x] SessionManager 단위 테스트 작성 (20개)
- [x] 레거시 Repository 테스트 제거

### Step 5: 검증
- [ ] 세션 전환 동작 확인 (통합 테스트 필요)
- [ ] 히스토리 추출 기능 확인 (통합 테스트 필요)
- [ ] 앱 재시작 후 세션 복원 확인 (통합 테스트 필요)
- [x] 모든 단위 테스트 통과 (196개)

> **Phase 02-6 구현 완료 (2026-02-04)**
> - SessionManager 구현 완료
> - app.py에서 레거시 Repository 제거 완료
> - 레거시 파일 삭제 완료 (conversation_repo.py, session_repo.py, summary.txt)
> - 단위 테스트 196개 통과

---

## 8. 예상 결과

### 8.1 코드 변화

| 항목 | 변경 전 | 변경 후 |
|------|--------|--------|
| Repository 클래스 | 3개 | 1개 (EmbeddingRepo만) |
| 저장소 | SQLite + CSV + JSON | SQLite만 |
| app.py 라인 수 | ~350 | ~280 (약 -70) |
| 데이터 중복 | 3중 | 없음 |

### 8.2 기능 비교

| 기능 | 변경 전 | 변경 후 |
|------|--------|--------|
| 세션 목록 | SessionRepo.list_sessions() | SessionManager.list_sessions() |
| 세션 전환 | conv_repo + session_repo 로드 | SqliteSaver 자동 복원 |
| 메시지 저장 | CSV 수동 저장 | SqliteSaver 자동 저장 |
| **히스토리 추출** | CSV 파일 직접 읽기 | SessionManager.get_session_history() |

---

## 9. 참고: LangGraph SqliteSaver 테이블 구조

```sql
-- checkpoints 테이블
CREATE TABLE checkpoints (
    thread_id TEXT,
    checkpoint_id TEXT,
    parent_id TEXT,
    checkpoint BLOB,  -- JSON으로 직렬화된 상태
    metadata BLOB,
    PRIMARY KEY (thread_id, checkpoint_id)
);

-- writes 테이블
CREATE TABLE writes (
    thread_id TEXT,
    checkpoint_id TEXT,
    task_id TEXT,
    idx INTEGER,
    channel TEXT,
    value BLOB,
    PRIMARY KEY (thread_id, checkpoint_id, task_id, idx)
);
```

`checkpoint` 컬럼에 JSON 형태로 `messages`, `summary`, `tool_results` 등 모든 상태가 저장됨.
